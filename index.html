<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>stock tracker</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Pretendard -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css"/>

  <!-- Brand Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Hentaigana:wght@400&display=swap" rel="stylesheet">

  <!-- React 18 + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#f9fbff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="stock tracker">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{ --bg:#f9fbff; --txt:#0f172a; --muted:#667085; --card:rgba(255,255,255,.82); --stroke:#e9eef5; }
    html, body { height:100%; background:#f7f9ff; }
    body{
      font-family:"Pretendard Variable", system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo","Malgun Gothic",sans-serif;
      color:var(--txt);
      background:
        radial-gradient(800px 420px at 12% -8%, #c9ecff99, transparent 60%),
        radial-gradient(820px 500px at 95% 2%, #ffd6f099, transparent 58%),
        radial-gradient(1200px 420px at 50% 85%, #e9d5ff4d, transparent 70%),
        linear-gradient(180deg, var(--bg) 0%, #f4f6ff 55%, #f8f2ff 100%);
      -webkit-tap-highlight-color: transparent;
    }
    .glass{ background:var(--card); backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px); border:1px solid rgba(255,255,255,.6); border-radius:18px; box-shadow:0 10px 30px rgba(2,6,23,.08); }
    .chip{ background:#f5f7fb; border:1px solid var(--stroke); border-radius:12px; padding:.6rem .8rem; }
    .btn{ border-radius:14px; padding:.9rem 1rem; background:linear-gradient(180deg,#fff,#f8fbff); border:1px solid rgba(255,255,255,.8); box-shadow:0 10px 20px rgba(2,6,23,.06), inset 0 1px 0 #fff; }
    .btn:active{ transform:translateY(1px); }
    .brand{ font-family:"Noto Serif Hentaigana", serif; font-size:clamp(28px,6vw,40px); line-height:1; letter-spacing:-.01em; }
    .subtitle{ font-size:clamp(13px,3.5vw,16px); color:#475569; margin-top:.35rem; }
    /* 모바일 탭 바 */
    .tabbar{ position:fixed; left:0; right:0; bottom:0; padding:calc(10px + env(safe-area-inset-bottom)); background:rgba(255,255,255,.6); backdrop-filter:blur(20px); border-top:1px solid #eef2f6; z-index:50; }
    .tabbtn{ flex:1; text-align:center; font-size:12px; padding:.4rem 0 .2rem; color:#6b7280; }
    .tabbtn.active{ color:#111827; font-weight:600; }
    /* 입력 UX */
    input[type="number"]{ -moz-appearance:textfield; }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    .field{ border:1px solid var(--stroke); border-radius:12px; padding:.8rem; width:100%; background:#fff; }
    .tag{ font-size:12px; color:#64748b; }
    /* 카드 스택(모바일 풀폭) */
    .panel{ margin:12px auto; padding:14px; width:min(720px, 94vw); }
    .stat{ background:#fff; border:1px solid #eef2f6; border-radius:14px; padding:.9rem; text-align:center; }
  </style>

  <script>
    // Service Worker 등록
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }
  </script>
</head>
<body>
  <!-- 부드러운 밴드 -->
  <div style="position:fixed;left:0;right:0;top:28vh;bottom:-10vh;z-index:-1;pointer-events:none;background:linear-gradient(180deg,rgba(255,255,255,0) 0%,rgba(248,244,255,.28) 35%,rgba(248,244,255,.22) 65%,rgba(255,255,255,0) 100%);"></div>

  <!-- Firebase (Cloud Sync) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmyHCDjElHWFruKUz1psMF_JlR8xXkdsc",
      authDomain: "stock-tracker-c5203.firebaseapp.com",
      projectId: "stock-tracker-c5203",
      storageBucket: "stock-tracker-c5203.firebasestorage.app",
      messagingSenderId: "653038109673",
      appId: "1:653038109673:web:cc17abb3796a6d4dff0178",
      measurementId: "G-JCT2JK3PP6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    enableIndexedDbPersistence(db).catch(()=>{});

    const userReady = new Promise(resolve=>{
      onAuthStateChanged(auth, async (user)=>{
        try{ if(!user) await signInAnonymously(auth); resolve(auth.currentUser); }
        catch{ resolve(null); }
      });
    });

    async function loadCloud(){
      const u = await userReady; if(!u) return null;
      const ref = doc(db, "users", u.uid);
      const snap = await getDoc(ref);
      return snap.exists()? snap.data() : null;
    }
    async function saveCloud(state){
      const u = await userReady; if(!u) return;
      const ref = doc(db, "users", u.uid);
      await setDoc(ref, { ...state, updatedAt: Date.now() }, { merge:true });
    }
    window.fb = { db, auth, userReady, loadCloud, saveCloud };
  </script>

  <div id="root" class="pb-[84px]"></div>

  <script type="text/babel">
    const {useState,useEffect,useMemo,useRef} = React;

    const STOCKS = [
      {key:"kakao", name:"카카오"},
      {key:"samsung", name:"삼성전자"},
      {key:"sm", name:"에스엠"},
    ];
    const defaultJournal = ()=>({
      id: (crypto?.randomUUID?.() ?? String(Date.now()+Math.random())),
      date: new Date().toISOString().slice(0,10),
      side:'매수', qty:'', price:'',
      plan:'', reason:'',
      target:'1% 절반 익절, 3~5% 연장', stop:'최대 -2%',
      resultPct:'', resultPnl:'',
      hold:false, tags:'스윙',
      good:'', feedback:''
    });
    const initialState = { settings:{ initialSeed:16000000 }, monthlyPnL:{}, journals:{ kakao:[], samsung:[], sm:[] } };

    function useCloudState(key, init){
      const [state, setState] = useState(init);
      const ready = useRef(false);

      useEffect(()=>{
        (async ()=>{
          try{
            const local = JSON.parse(localStorage.getItem(key)||'null') || init;
            let base = local;
            const cloud = await window.fb?.loadCloud();
            if (cloud){
              base = {
                settings:{...local.settings, ...cloud.settings},
                monthlyPnL:{...local.monthlyPnL, ...cloud.monthlyPnL},
                journals: cloud.journals ?? local.journals
              };
            }
            setState(base);
            ready.current = true;
          }catch{
            setState(init);
            ready.current = true;
          }
        })();
      }, []);

      useEffect(()=>{
        if(!ready.current) return;
        try{ localStorage.setItem(key, JSON.stringify(state)); }catch{}
        const t = setTimeout(()=> window.fb?.saveCloud(state), 500);
        return ()=> clearTimeout(t);
      }, [state]);

      return [state, setState];
    }

    const currency = n => Number(n||0).toLocaleString();

    /* 공통 카드 섹션 */
    const Panel = ({title, children, right}) => (
      <section className="panel glass">
        <header className="flex items-center justify-between mb-2">
          <h2 className="text-[15px] font-semibold">{title}</h2>
          {right}
        </header>
        {children}
      </section>
    );

    function MonthlyCard({state,setMonthly}){
      const [year,setYear]=useState(new Date().getFullYear());
      const months=Array.from({length:12},(_,i)=>i+1);
      const ym=(y,m)=>`${y}-${String(m).padStart(2,'0')}`;

      const sum = useMemo(()=> Object.entries(state.monthlyPnL)
        .filter(([k])=> k.startsWith(String(year)))
        .reduce((s,[,v])=> s + Number(v||0), 0), [state,year]);

      return (
        <Panel title="월별 실현 손익" right={
          <select className="chip text-xs" value={year} onChange={e=>setYear(+e.target.value)}>
            {Array.from({length:6},(_,i)=> new Date().getFullYear()-3+i).map(y=><option key={y}>{y}</option>)}
          </select>
        }>
          <div className="grid grid-cols-2 gap-2">
            {months.map(m=>{
              const key=ym(year,m);
              const v=state.monthlyPnL[key] ?? '';
              return (
                <div key={key} className="space-y-1">
                  <div className="text-xs tag">{m}월</div>
                  <input className="field text-center"
                         inputMode="numeric" pattern="[0-9]*"
                         placeholder="예: 140000"
                         value={v}
                         onChange={e=>setMonthly(key, e.target.value.replace(/[^0-9-]/g,''))}/>
                </div>
              );
            })}
          </div>
          <div className="grid grid-cols-3 gap-2 mt-3">
            <div className="stat"><div className="tag mb-1">연간 합계</div><div className="font-semibold">{currency(sum)} 원</div></div>
            <SeedStat/>
            <RoiStat/>
          </div>
        </Panel>
      );
    }

    function QuickNew({add}){
      return (
        <Panel title="새 일지">
          <div className="grid grid-cols-3 gap-2">
            {STOCKS.map(s=><button key={s.key} className="btn" onClick={()=>add(s.key)}>{s.name}</button>)}
          </div>
          <p className="text-xs tag mt-3">버튼을 눌러 바로 일지를 추가할 수 있어요.</p>
        </Panel>
      );
    }

    function GuideInline(){
      return (
        <div className="px-4 py-8 text-center text-[13px] text-[#6b7280]">
          월별 금액은 입력해 두면 저장됩니다 · 좌우 버튼으로 화면 이동 · 일지는 ‘잘한 점/피드백’으로 나눠 기록 · 모든 데이터는 기기 간 자동 동기화
        </div>
      );
    }

    function Editor({data,setData,onClose,onSave}){
      if(!data) return null;
      const e=data.entry;
      const up=(k,v)=> setData(p=>({...p, entry:{...p.entry, [k]:v}}));
      return (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/30" onClick={onClose}></div>
          <div className="absolute inset-x-0 bottom-0 glass rounded-t-2xl p-4 max-h-[85vh] overflow-auto">
            <div className="flex items-center justify-between">
              <div className="text-sm tag">일지 입력 · {data.stock}</div>
              <button className="chip" onClick={onClose}>닫기</button>
            </div>
            <div className="grid grid-cols-2 gap-2 mt-3">
              <div><div className="tag mb-1">날짜</div><input type="date" className="field" value={e.date} onChange={ev=>up('date',ev.target.value)}/></div>
              <div><div className="tag mb-1">사이드</div>
                <select className="field" value={e.side} onChange={ev=>up('side',ev.target.value)}>
                  <option>매수</option><option>매도</option><option>관망</option><option>청산</option>
                </select>
              </div>
              <div><div className="tag mb-1">수량</div><input className="field" inputMode="numeric" value={e.qty} onChange={ev=>up('qty',ev.target.value.replace(/[^0-9]/g,''))}/></div>
              <div><div className="tag mb-1">가격</div><input className="field" inputMode="numeric" value={e.price} onChange={ev=>up('price',ev.target.value.replace(/[^0-9]/g,''))}/></div>
              <div className="col-span-2"><div className="tag mb-1">부분익절/목표</div><input className="field" value={e.target} onChange={ev=>up('target',ev.target.value)}/></div>
              <div className="col-span-2"><div className="tag mb-1">리스크/손절</div><input className="field" value={e.stop} onChange={ev=>up('stop',ev.target.value)}/></div>
              <div className="col-span-2"><div className="tag mb-1">진입 계획</div><textarea rows="2" className="field" value={e.plan} onChange={ev=>up('plan',ev.target.value)}></textarea></div>
              <div className="col-span-2"><div className="tag mb-1">실행/종료 이유</div><textarea rows="2" className="field" value={e.reason} onChange={ev=>up('reason',ev.target.value)}></textarea></div>
              <div><div className="tag mb-1">실현 수익률(%)</div><input className="field" inputMode="decimal" value={e.resultPct} onChange={ev=>up('resultPct',ev.target.value.replace(/[^0-9.-]/g,''))}/></div>
              <div><div className="tag mb-1">실현 손익(₩)</div><input className="field" inputMode="numeric" value={e.resultPnl} onChange={ev=>up('resultPnl',ev.target.value.replace(/[^0-9-]/g,''))}/></div>
              <div><div className="tag mb-1">보유</div>
                <select className="field" value={e.hold?'Y':'N'} onChange={ev=>up('hold',ev.target.value==='Y')}><option value="N">아니오</option><option value="Y">예</option></select>
              </div>
              <div><div className="tag mb-1">태그</div><input className="field" value={e.tags} onChange={ev=>up('tags',ev.target.value)}/></div>
              <div className="col-span-2"><div className="tag mb-1">잘한 점</div><textarea rows="2" className="field" value={e.good} onChange={ev=>up('good',ev.target.value)}></textarea></div>
              <div className="col-span-2"><div className="tag mb-1">피드백</div><textarea rows="3" className="field" value={e.feedback} onChange={ev=>up('feedback',ev.target.value)}></textarea></div>
            </div>
            <div className="grid grid-cols-2 gap-2 mt-3">
              <button className="chip" onClick={onClose}>취소</button>
              <button className="btn" onClick={onSave}>저장</button>
            </div>
          </div>
        </div>
      );
    }

    function SeedStat(){
      const {totals} = React.useContext(AppCtx);
      return <div className="stat"><div className="tag mb-1">현재 시드</div><div className="font-semibold">{currency(totals.currentSeed)} 원</div></div>;
    }
    function RoiStat(){
      const {totals} = React.useContext(AppCtx);
      const pct = isFinite(totals.roi)? (Math.round(totals.roi*10)/10).toFixed(1) : '0.0';
      return <div className="stat"><div className="tag mb-1">수익률</div><div className="font-semibold">{pct} %</div></div>;
    }

    const AppCtx = React.createContext({totals:{}, count:0});

    function JournalList({state,setState,stock,onEdit}){
      const items = state.journals[stock] || [];
      const del = (id)=>{ if(confirm('삭제할까요?')) setState(p=>({...p, journals:{...p.journals, [stock]: items.filter(x=>x.id!==id)}})); };
      return (
        <Panel title={`일지 · ${STOCKS.find(s=>s.key===stock).name}`}>
          {items.length===0 && <div className="text-center tag py-6">아직 기록이 없어요.</div>}
          <div className="space-y-2">
            {items.map(e=>(
              <div key={e.id} className="glass p-3 rounded-xl">
                <div className="flex justify-between text-sm">
                  <div>{e.date} · <span className="text-gray-500">{e.side}</span></div>
                  <div className={(+e.resultPnl||0)>=0?'text-emerald-600':'text-rose-600'}>{e.resultPnl||''}</div>
                </div>
                {e.feedback && <div className="mt-2 text-[13px] text-gray-700">{e.feedback}</div>}
                <div className="flex gap-2 mt-2">
                  <button className="chip flex-1" onClick={()=>onEdit(e.id)}>수정</button>
                  <button className="chip flex-1" style={{color:'#dc2626',borderColor:'#fecaca'}} onClick={()=>del(e.id)}>삭제</button>
                </div>
              </div>
            ))}
          </div>
        </Panel>
      );
    }

    function App(){
      const [state,setState] = useCloudState('tracker-app', initialState);
      const [tab,setTab] = useState('home');        // home | journal | settings
      const [stockTab,setStockTab] = useState(STOCKS[0].key);
      const [editing,setEditing] = useState(null);

      const realized = useMemo(()=> Object.values(state.journals).flatMap(v=>v).filter(e=> !e.hold && Number(e.resultPnl||0)!==0), [state]);
      const totals = useMemo(()=>{
        const pnl = realized.reduce((s,e)=> s + Number(e.resultPnl||0), 0);
        const initialSeed = Number(state.settings?.initialSeed || 0);
        const currentSeed = initialSeed + pnl;
        const roi = initialSeed>0 ? (pnl/initialSeed)*100 : 0;
        return {pnl, initialSeed, currentSeed, roi};
      }, [realized, state.settings]);

      const setMonthly = (ym,v)=> setState(p=>({...p, monthlyPnL:{...p.monthlyPnL, [ym]:v}}));
      const setInitialSeed = v => setState(p=>({...p, settings:{...p.settings, initialSeed:v}}));

      const addEntry = (stock)=> setEditing({stock, entry: defaultJournal()});
      const saveEntry = ()=>{
        const {stock, entry} = editing;
        setState(prev=>{
          const exists = prev.journals[stock].some(e=> e.id===entry.id);
          const next = exists ? prev.journals[stock].map(e=> e.id===entry.id? entry:e) : [entry, ...prev.journals[stock]];
          return {...prev, journals:{...prev.journals, [stock]: next}};
        });
        setEditing(null);
      };

      return (
        <AppCtx.Provider value={{totals}}>
          <div className="max-w-xl mx-auto px-3 pt-[18px]">
            <!-- 헤더 -->
            <div className="px-1">
              <div className="brand">stock tracker</div>
              <div className="subtitle">swing diary & monthly pnl · cloud sync</div>
            </div>

            {tab==='home' && (
              <>
                <MonthlyCard state={state} setMonthly={setMonthly}/>
                <QuickNew add={addEntry}/>
                <GuideInline/>
              </>
            )}

            {tab==='journal' && (
              <>
                <Panel title="종목 선택">
                  <div className="grid grid-cols-3 gap-2">
                    {STOCKS.map(s=>(
                      <button key={s.key} className={"btn "+(stockTab===s.key?'ring-2 ring-cyan-200':'')} onClick={()=>setStockTab(s.key)}>{s.name}</button>
                    ))}
                  </div>
                </Panel>
                <JournalList state={state} setState={setState} stock={stockTab}
                             onEdit={(id)=>{ const e = state.journals[stockTab].find(x=>x.id===id); if(e) setEditing({stock:stockTab, entry:{...e}}); }}/>
              </>
            )}

            {tab==='settings' && (
              <>
                <Panel title="초기 시드">
                  <div className="flex items-center gap-2">
                    <input className="field text-right" value={state.settings.initialSeed}
                      inputMode="numeric"
                      onChange={e=>setInitialSeed(Number((e.target.value||'0').replace(/[^0-9]/g,'')))}/>
                    <span>원</span>
                  </div>
                </Panel>
                <Panel title="백업/복원">
                  <div className="grid grid-cols-2 gap-2">
                    <button className="btn" onClick={()=>{
                      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
                      const url = URL.createObjectURL(blob); const a = document.createElement('a');
                      a.href=url; a.download=`tracker-backup-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
                    }}>JSON 백업</button>
                    <label className="btn text-center">복원
                      <input type="file" className="hidden" accept="application/json" onChange={e=>{
                        const f=e.target.files?.[0]; if(!f) return;
                        const r=new FileReader(); r.onload=()=>{ try{ setState(JSON.parse(r.result)); }catch{ alert('형식 오류'); } }; r.readAsText(f);
                      }}/>
                    </label>
                  </div>
                </Panel>
              </>
            )}
          </div>

          {/* 하단 탭바 */}
          <nav className="tabbar flex items-center gap-2">
            <button className={"tabbtn "+(tab==='home'?'active':'')} onClick={()=>setTab('home')}>대시보드</button>
            <button className={"tabbtn "+(tab==='journal'?'active':'')} onClick={()=>setTab('journal')}>일지</button>
            <button className={"tabbtn "+(tab==='settings'?'active':'')} onClick={()=>setTab('settings')}>설정</button>
          </nav>

          <Editor data={editing} setData={setEditing} onClose={()=>setEditing(null)} onSave={saveEntry}/>
        </AppCtx.Provider>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>